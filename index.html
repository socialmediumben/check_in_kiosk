<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Check-In</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .stage { display: none; }
        .active-stage { display: block; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #fff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-lg text-center">

        <div id="stage-setup" class="stage active-stage">
            <h1 class="text-3xl font-bold text-gray-800">Admin Setup</h1>
            <p class="text-gray-500 mt-2 mb-6">Please enter the Square Access Token to activate this kiosk.</p>
            <div class="flex items-center space-x-3">
                <input type="password" id="square-token" class="flex-grow block w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md" placeholder="Square Access Token">
                <button id="save-token-btn" class="px-6 py-2 text-white bg-cyan-600 rounded-md hover:bg-cyan-700">Save</button>
            </div>
        </div>

        <div id="stage-1-search" class="stage">
            <h1 class="text-4xl font-bold text-gray-800">Customer Check-In</h1>
            <p class="text-gray-500 mt-2 mb-8">Please enter your phone number to begin.</p>
            <div class="flex items-center space-x-3">
                <input type="tel" id="search-value" class="flex-grow block w-full px-4 py-3 text-2xl text-center text-gray-700 bg-white border border-gray-300 rounded-md" placeholder="e.g., (415) 555-1234">
                <button id="search-btn" class="px-8 py-3 text-white bg-cyan-600 rounded-md hover:bg-cyan-700 text-xl">Search</button>
            </div>
        </div>
        
        <div id="stage-2-results" class="stage">
            <h1 class="text-4xl font-bold text-gray-800">Is this you?</h1>
            <p class="text-gray-500 mt-2 mb-8">Please tap your name to confirm.</p>
            <div id="results-list" class="space-y-4"></div>
            <button id="back-to-search-btn" class="mt-8 px-6 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300">Back to Search</button>
        </div>
        
        <div id="stage-3-welcome" class="stage">
            <div id="welcome-message" class="mb-8"></div>
            <div id="club-check-ins-container" class="mt-8"></div>
            <button id="start-over-btn" class="w-full px-8 py-4 text-white bg-cyan-600 rounded-md hover:bg-cyan-700 text-xl mt-8">Done</button>
        </div>

        <div id="loader" class="hidden items-center justify-center mt-6">
            <div class="spinner"></div>
            <p class="ml-4 text-gray-600">Please wait...</p>
        </div>
        <div id="error-box" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-md"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stages = { setup: document.getElementById('stage-setup'), search: document.getElementById('stage-1-search'), results: document.getElementById('stage-2-results'), welcome: document.getElementById('stage-3-welcome') };
            const saveTokenBtn = document.getElementById('save-token-btn');
            const searchBtn = document.getElementById('search-btn');
            const resultsList = document.getElementById('results-list');
            const welcomeMessageContainer = document.getElementById('welcome-message');
            const clubCheckInsContainer = document.getElementById('club-check-ins-container');
            const startOverBtn = document.getElementById('start-over-btn');
            const backToSearchBtn = document.getElementById('back-to-search-btn');
            const loader = document.getElementById('loader');
            const errorBox = document.getElementById('error-box');

            let squareAccessToken = null;
            let allSegmentsMap = new Map();
            let selectedCustomer = null;
            let clubCheckInItems = [];
            let locationId = null;

            const API_PROXY_URL = 'https://square-checkin-backend.onrender.com';

            const showLoader = (message) => { Object.values(stages).forEach(s => s.classList.remove('active-stage')); loader.querySelector('p').textContent = message || 'Processing...'; loader.style.display = 'flex'; errorBox.style.display = 'none'; };
            const hideLoader = () => loader.style.display = 'none';
            const showError = (message) => { errorBox.textContent = `Error: ${message}`; errorBox.style.display = 'block'; };
            const hideError = () => errorBox.style.display = 'none';
            const showStage = (stageName) => { hideLoader(); hideError(); Object.values(stages).forEach(s => s.classList.remove('active-stage')); if (stages[stageName]) stages[stageName].classList.add('active-stage'); };
            
            const apiFetch = async (endpoint, options = {}) => {
                const response = await fetch(`${API_PROXY_URL}/api${endpoint}`, {
                    ...options,
                    headers: { ...options.headers, 'x-square-access-token': squareAccessToken, 'Content-Type': 'application/json' },
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.errors?.[0]?.detail || data.error || 'An API error occurred.');
                return data;
            };

            const fetchInitialData = async () => {
                showLoader('Activating kiosk and fetching catalog...');
                try {
                    await Promise.all([ fetchAllSegments(), fetchClubCheckInItems(), fetchLocationId() ]);
                    showStage('search');
                } catch (error) {
                    showError(error.message);
                    showStage('setup');
                }
            };
            
            const fetchAllSegments = async () => {
                const data = await apiFetch('/v2/customers/segments');
                allSegmentsMap.clear();
                if (data.segments) data.segments.forEach(s => allSegmentsMap.set(s.id, s.name));
            };

            const fetchClubCheckInItems = async () => {
                try {
                    // First, fetch all categories to ensure we find subcategories.
                    const categoryData = await apiFetch('/v2/catalog/search', {
                        method: 'POST',
                        body: JSON.stringify({ object_types: ["CATEGORY"] })
                    });
                    // UPDATED to search for the parent category "Check-Ins" as a test.
                    const category = categoryData.objects?.find(obj => obj.category_data.name.toLowerCase() === 'check-ins');
                    
                    if (!category) {
                        console.warn('"Check-Ins" category not found. Skipping additional check-in options.');
                        clubCheckInItems = [];
                        return;
                    }

                    // Now, find all items within that category
                    const itemsData = await apiFetch('/v2/catalog/search', {
                        method: 'POST',
                        body: JSON.stringify({ object_types: ["ITEM"], query: { "item_query": { "category_ids": [category.id] } } })
                    });

                    clubCheckInItems = itemsData.objects?.map(item => ({
                        name: item.item_data.name,
                        id: item.item_data.variations?.[0]?.id
                    })).filter(item => item.id) || [];
                } catch (error) {
                    console.error("Could not fetch club check-in items:", error);
                    // If this fails for any reason, default to an empty list so the app doesn't crash.
                    clubCheckInItems = [];
                }
            };

            const fetchLocationId = async () => {
                const data = await apiFetch('/v2/locations');
                const activeLocation = data.locations?.find(loc => loc.status === 'ACTIVE');
                if (!activeLocation) throw new Error('No active location found for this business.');
                locationId = activeLocation.id;
            };

            const searchCustomers = async () => {
                const searchValue = document.getElementById('search-value').value.trim();
                if (!searchValue) return;
                showLoader('Searching...');
                let formattedPhone = searchValue.replace(/\D/g, '');
                if (formattedPhone.length === 10) formattedPhone = `+1${formattedPhone}`;
                else if (!searchValue.startsWith('+')) formattedPhone = `+${formattedPhone}`;
                else formattedPhone = `+${formattedPhone.substring(1)}`;
                try {
                    const data = await apiFetch('/v2/customers/search', {
                        method: 'POST',
                        body: JSON.stringify({ query: { filter: { phone_number: { exact: formattedPhone } } } })
                    });
                    displayCustomerResults(data.customers || []);
                    showStage('results');
                } catch (error) {
                    showError(error.message);
                    showStage('search');
                }
            };
            
            const displayCustomerResults = (customers) => {
                resultsList.innerHTML = '';
                if (customers.length === 0) {
                    resultsList.innerHTML = '<p class="text-gray-500 text-center p-4">No customers found with that phone number.</p>';
                    return;
                }
                customers.forEach(customer => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-center p-4 bg-white border-2 border-gray-300 rounded-md hover:border-cyan-500 focus:border-cyan-500 transition-all text-2xl font-semibold';
                    button.textContent = `${customer.given_name || ''} ${customer.family_name || ''}`;
                    button.onclick = () => {
                        selectedCustomer = customer;
                        showStage('welcome');
                        displayWelcomeMessage();
                        displayClubCheckInButtons();
                    };
                    resultsList.appendChild(button);
                });
            };

            const displayWelcomeMessage = () => {
                if (!selectedCustomer) return;
                const segmentIds = selectedCustomer.segment_ids || [];
                const thankYouMessages = [];
                segmentIds.forEach(id => {
                    const name = allSegmentsMap.get(id) || '';
                    if (name.toLowerCase().includes('current')) {
                        const modifiedName = name.replace(/current/i, '').trim();
                        const article = /^[aeiou]/i.test(modifiedName) ? 'an' : 'a';
                        thankYouMessages.push(`Thank you for being ${article} ${modifiedName}`);
                    }
                });
                let membershipHTML = '<p class="text-2xl text-red-500">No Current Membership Found</p>';
                if (thankYouMessages.length > 0) {
                    membershipHTML = thankYouMessages.map(message => `<li class="text-2xl font-medium text-gray-700 list-none">${message}</li>`).join('');
                    membershipHTML = `<ul class="space-y-2">${membershipHTML}</ul>`;
                }
                welcomeMessageContainer.innerHTML = `<h1 class="text-5xl font-bold text-gray-800 mb-4">Welcome, ${selectedCustomer.given_name || ''}!</h1>${membershipHTML}`;
            };

            const displayClubCheckInButtons = () => {
                clubCheckInsContainer.innerHTML = '';
                if (clubCheckInItems.length === 0) return;

                const title = document.createElement('h2');
                title.className = 'text-xl font-semibold text-gray-800 mb-4 mt-8';
                title.textContent = 'Record Additional Check-in:';
                clubCheckInsContainer.appendChild(title);
                
                const buttonGrid = document.createElement('div');
                buttonGrid.className = 'grid grid-cols-2 gap-4';

                clubCheckInItems.forEach(item => {
                    const button = document.createElement('button');
                    button.className = 'p-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 font-semibold';
                    button.textContent = item.name;
                    button.onclick = () => createItemPurchase(item.id, button);
                    buttonGrid.appendChild(button);
                });
                clubCheckInsContainer.appendChild(buttonGrid);
            };

            const createItemPurchase = async (itemId, buttonElement) => {
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div></div>';
                
                try {
                    const orderPayload = { idempotency_key: crypto.randomUUID(), order: { location_id: locationId, customer_id: selectedCustomer.id, line_items: [{ catalog_object_id: itemId, quantity: '1' }] } };
                    const orderData = await apiFetch('/v2/orders', { method: 'POST', body: JSON.stringify(orderPayload) });
                    const payPayload = { idempotency_key: crypto.randomUUID(), payment_ids: [] };
                    await apiFetch(`/v2/orders/${orderData.order.id}/pay`, { method: 'POST', body: JSON.stringify(payPayload) });
                    
                    buttonElement.className = 'p-4 bg-green-500 text-white rounded-md font-semibold';
                    buttonElement.textContent = 'âœ“ Recorded';
                } catch (error) {
                    buttonElement.className = 'p-4 bg-red-500 text-white rounded-md font-semibold';
                    buttonElement.textContent = 'Failed';
                    // Re-enable after a delay so user can retry
                    setTimeout(() => {
                        buttonElement.disabled = false;
                        buttonElement.className = 'p-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 font-semibold';
                        buttonElement.textContent = 'Retry';
                    }, 3000);
                }
            };

            saveTokenBtn.addEventListener('click', () => {
                const tokenInput = document.getElementById('square-token');
                squareAccessToken = tokenInput.value.trim();
                if (squareAccessToken) fetchInitialData();
                else showError('Please enter a valid Square Access Token.');
            });

            searchBtn.addEventListener('click', searchCustomers);
            startOverBtn.addEventListener('click', () => { document.getElementById('search-value').value = ''; selectedCustomer = null; showStage('search'); });
            backToSearchBtn.addEventListener('click', () => { document.getElementById('search-value').value = ''; selectedCustomer = null; showStage('search'); });
        });
    </script>
</body>
</html>
