<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teen Check-In Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .stage { display: none; }
        .active-stage { display: block; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #06b6d4; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg text-center">

        <div id="stage-setup" class="stage active-stage">
            <h1 class="text-3xl font-bold text-gray-800">Admin Setup</h1>
            <p class="text-gray-500 mt-2 mb-6">Please enter the Square Access Token to activate this kiosk.</p>
            <div class="flex items-center space-x-3">
                <input type="password" id="square-token" class="flex-grow block w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md" placeholder="Square Access Token">
                <button id="save-token-btn" class="px-6 py-2 text-white bg-cyan-600 rounded-md hover:bg-cyan-700">Save</button>
            </div>
        </div>

        <div id="stage-1-list" class="stage">
            <h1 class="text-4xl font-bold text-gray-800">Teen Club Check-In</h1>
            <p class="text-gray-500 mt-2 mb-8">Please tap your name to check in.</p>
            <div id="results-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
        
        <div id="stage-2-welcome" class="stage">
            <div id="welcome-message" class="mb-8"></div>
            <button id="start-over-btn" class="w-full px-8 py-4 text-white bg-cyan-600 rounded-md hover:bg-cyan-700 text-xl mt-8">Done</button>
        </div>

        <div id="loader" class="hidden items-center justify-center mt-6">
            <div class="spinner"></div>
            <p class="ml-4 text-gray-600">Please wait...</p>
        </div>
        <div id="error-box" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-md"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stages = { setup: document.getElementById('stage-setup'), list: document.getElementById('stage-1-list'), welcome: document.getElementById('stage-2-welcome') };
            const saveTokenBtn = document.getElementById('save-token-btn');
            const resultsList = document.getElementById('results-list');
            const welcomeMessageContainer = document.getElementById('welcome-message');
            const startOverBtn = document.getElementById('start-over-btn');
            const loader = document.getElementById('loader');
            const errorBox = document.getElementById('error-box');

            let squareAccessToken = null;
            let locationId = null;
            let checkInItemIds = {};

            const API_PROXY_URL = 'https://square-checkin-backend.onrender.com';

            const showLoader = (message) => { Object.values(stages).forEach(s => s.classList.remove('active-stage')); loader.querySelector('p').textContent = message || 'Processing...'; loader.style.display = 'flex'; errorBox.style.display = 'none'; };
            const hideLoader = () => loader.style.display = 'none';
            const showError = (message) => { errorBox.textContent = `Error: ${message}`; errorBox.style.display = 'block'; };
            const hideError = () => errorBox.style.display = 'none';
            const showStage = (stageName) => { hideLoader(); hideError(); Object.values(stages).forEach(s => s.classList.remove('active-stage')); if (stages[stageName]) stages[stageName].classList.add('active-stage'); };
            
            const apiFetch = async (endpoint, options = {}) => {
                const response = await fetch(`${API_PROXY_URL}/api${endpoint}`, {
                    ...options,
                    headers: { ...options.headers, 'x-square-access-token': squareAccessToken, 'Content-Type': 'application/json' },
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.errors?.[0]?.detail || data.error || 'An API error occurred.');
                return data;
            };

            const fetchInitialData = async () => {
                showLoader('Activating Kiosk & Fetching Members...');
                try {
                    await fetchLocationId();
                    await findCheckInItems();
                    const members = await fetchTeenMembers();
                    displayTeenMembers(members);
                    showStage('list');
                } catch (error) {
                    showError(error.message);
                    showStage('setup');
                }
            };

            const fetchLocationId = async () => {
                const data = await apiFetch('/v2/locations');
                const activeLocation = data.locations?.find(loc => loc.status === 'ACTIVE');
                if (!activeLocation) throw new Error('No active location found for this business.');
                locationId = activeLocation.id;
            };

            const findCheckInItems = async () => {
                const itemNames = ["Check-In", "Teen Club Check-In"];
                const data = await apiFetch('/v2/catalog/search', {
                    method: 'POST',
                    body: JSON.stringify({ object_types: ["ITEM"], query: { text_query: { keywords: itemNames } } })
                });
                if (data.objects) {
                    itemNames.forEach(name => {
                        const item = data.objects.find(obj => obj.item_data.name.toLowerCase() === name.toLowerCase());
                        if (item && item.item_data.variations?.[0]?.id) {
                            checkInItemIds[name] = item.item_data.variations[0].id;
                        }
                    });
                }
                if (!checkInItemIds["Check-In"] || !checkInItemIds["Teen Club Check-In"]) {
                    throw new Error('Could not find both "Check-In" and "Teen Club Check-In" items in your catalog.');
                }
            };

            const fetchTeenMembers = async () => {
                const segmentData = await apiFetch('/v2/customers/segments');
                const teenSegment = segmentData.segments?.find(s => s.name.toLowerCase() === 'current teen member');
                if (!teenSegment) {
                    throw new Error('Could not find the "Current Teen Member" smart group.');
                }
                const customerData = await apiFetch('/v2/customers/search', {
                    method: 'POST',
                    body: JSON.stringify({ query: { filter: { segment_ids: { any: [teenSegment.id] } } } })
                });
                return customerData.customers || [];
            };

            const displayTeenMembers = (members) => {
                resultsList.innerHTML = '';
                if (members.length === 0) {
                    resultsList.innerHTML = '<p class="text-gray-500 text-center p-4 col-span-full">No members found in the "Current Teen Member" group.</p>';
                    return;
                }
                members.sort((a, b) => (a.given_name || '').localeCompare(b.given_name)); // Sort alphabetically by first name
                members.forEach(member => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-center p-4 bg-white border-2 border-gray-300 rounded-md hover:border-cyan-500 focus:border-cyan-500 transition-all text-xl font-semibold';
                    button.textContent = `${member.given_name || ''} ${member.family_name || ''}`;
                    button.onclick = () => handleTeenSelection(member);
                    resultsList.appendChild(button);
                });
            };

            const handleTeenSelection = async (member) => {
                showLoader(`Checking in ${member.given_name || ''}...`);
                try {
                    await createCheckInPurchases(member);
                    welcomeMessageContainer.innerHTML = `<h1 class="text-5xl font-bold text-gray-800">Welcome, ${member.given_name || ''}!</h1><p class="text-2xl mt-4 text-green-600">You are checked in.</p>`;
                    showStage('welcome');
                } catch (error) {
                    showError(`Check-in failed: ${error.message}`);
                    showStage('list');
                }
            };

            const createCheckInPurchases = async (member) => {
                const lineItems = [
                    { catalog_object_id: checkInItemIds["Check-In"], quantity: '1' },
                    { catalog_object_id: checkInItemIds["Teen Club Check-In"], quantity: '1' }
                ];
                const orderPayload = {
                    idempotency_key: crypto.randomUUID(),
                    order: {
                        location_id: locationId,
                        customer_id: member.id,
                        line_items: lineItems
                    }
                };
                const orderData = await apiFetch('/v2/orders', { method: 'POST', body: JSON.stringify(orderPayload) });
                const payPayload = { idempotency_key: crypto.randomUUID(), payment_ids: [] };
                await apiFetch(`/v2/orders/${orderData.order.id}/pay`, { method: 'POST', body: JSON.stringify(payPayload) });
            };

            saveTokenBtn.addEventListener('click', () => {
                const tokenInput = document.getElementById('square-token');
                squareAccessToken = tokenInput.value.trim();
                if (squareAccessToken) fetchInitialData();
                else showError('Please enter a valid Square Access Token.');
            });
            
            startOverBtn.addEventListener('click', () => {
                showLoader('Loading members...');
                fetchTeenMembers().then(members => {
                    displayTeenMembers(members);
                    showStage('list');
                }).catch(error => {
                    showError(error.message);
                    showStage('setup');
                });
            });
        });
    </script>
</body>
</html>
